<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Onyx Transfer | Panel Administrativo</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" type="text/css" href="./css/styles.css" />
    <link rel="stylesheet" type="text/css" href="./css/panel.css" />
  </head>
  <body>
    <header class="panel-header">
      <span class="panel-title">Onyx Transfer â€“ Admin</span>
    </header>
    <main>
      <!-- ConfiguraciÃ³n RÃ¡pida -->
      <div class="config-container">
        <div class="rate-card">
          <div>
            <h3>Tasa CUP</h3>
            <input
              type="number"
              id="tasa_cambio"
              step="0.1"
              style="width: 80px"
            />
          </div>
          <div style="border-left: 1px solid var(--border); padding-left: 15px">
            <h3>Cuenta Zelle</h3>
            <input
              type="text"
              id="zelle_cuenta"
              placeholder="+1 234 567 8901 (solo nÃºmero EE.UU.)"
            />
          </div>
          <div style="border-left: 1px solid var(--border); padding-left: 15px">
            <h3>Propietario Zelle</h3>
            <input
              type="text"
              id="zelle_owner"
              placeholder="Nombre del propietario"
            />
          </div>
          <button class="btn-primary" onclick="actualizarConfig()">
            Actualizar
          </button>
        </div>
        <div id="update-timer">Actualizando en: 15s</div>
      </div>

      <!-- Dashboard -->
      <div class="dashboard">
        <div class="card" onclick="abrirModal('modal-transacciones')">
          <h3>ðŸ’¸ Transferencias</h3>
          <p>Gestionar envÃ­os</p>
        </div>
        <div class="card" onclick="abrirModal('modal-metricas')">
          <h3>ðŸ“Š Resumen de operaciones</h3>
          <p>Totales de hoy y del mes</p>
        </div>
        <div class="card" onclick="exportarCSV()">
          <h3>ðŸ“¥ Reporte CSV</h3>
          <p>Descargar base de datos</p>
        </div>
      </div>
    </main>

    <!--  modal-transacciones -->
    <div id="modal-transacciones" class="modal">
      <!-- Dentro de modal-transacciones -->
      <div class="modal-content">
        <span class="close" onclick="cerrarModal('modal-transacciones')"
          >&times;</span
        >

        <h2 style="margin-bottom: 20px">GestiÃ³n de transferencias</h2>

        <!-- BARRA DE FILTROS -->
        <div class="filter-bar">
          <input
            type="text"
            id="f-search"
            placeholder="ðŸ” Buscar nombre..."
            oninput="resetYPaginaciÃ³n()"
          />
          <select id="f-estado" onchange="resetYPaginaciÃ³n()">
            <option value="todos">Todos los estados</option>
            <option value="pending">Pendientes</option>
            <option value="approved">Confirmados</option>
            <option value="rejected">Rechazados</option>
          </select>
          <div class="date-range">
            <input type="date" id="f-inicio" onchange="resetYPaginaciÃ³n()" />
            <span>a</span>
            <input type="date" id="f-fin" onchange="resetYPaginaciÃ³n()" />
          </div>
        </div>

        <div class="table-container">
          <table id="tabla-transacciones">
            <thead>
              <tr>
                <th onclick="setSort('sender')" id="th-sender">Remitente</th>
                <th onclick="setSort('recipient')" id="th-recipient">
                  Beneficiario
                </th>
                <th>DirecciÃ³n</th>
                <th onclick="setSort('whatsapp')" id="th-whatsapp">WhatsApp</th>
                <th onclick="setSort('usd')" id="th-usd">USD</th>
                <th onclick="setSort('cup')" id="th-cup">CUP</th>
                <th>Recibo</th>
                <th onclick="setSort('state')" id="th-state">Estado</th>
                <th>AcciÃ³n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- CONTROLES DE PAGINACIÃ“N -->
        <div class="pagination-container">
          <button onclick="cambiarPagina(-1)" id="btn-prev">Anterior</button>
          <span id="page-info"></span>
          <button onclick="cambiarPagina(1)" id="btn-next">Siguiente</button>
        </div>
      </div>
    </div>

    <!-- Modal MÃ©tricas -->
    <div id="modal-metricas" class="modal">
      <div class="modal-content" style="max-width: 1000px">
        <span class="close" onclick="cerrarModal('modal-metricas')"
          >&times;</span
        >
        <h2>Resumen de operaciones</h2>

        <!-- GrÃ¡ficos DÃ­a y Mes -->
        <div class="charts-container">
          <div class="chart-card">
            <h3>ðŸ“… Operaciones de hoy</h3>
            <div class="chart-grid">
              <div class="chart-item">
                <span class="chart-label">Cantidad</span>
                <span class="chart-value" id="chart-day-qty">0</span>
              </div>
              <div class="chart-item">
                <span class="chart-label">USD</span>
                <span class="chart-value" id="chart-day-usd">$0.00</span>
              </div>
              <div class="chart-item">
                <span class="chart-label">CUP</span>
                <span class="chart-value" id="chart-day-cup">0 CUP</span>
              </div>
            </div>
          </div>

          <div class="chart-card">
            <h3>ðŸ“Š Operaciones del mes</h3>
            <div class="chart-grid">
              <div class="chart-item">
                <span class="chart-label">Cantidad</span>
                <span class="chart-value" id="chart-month-qty">0</span>
              </div>
              <div class="chart-item">
                <span class="chart-label">USD</span>
                <span class="chart-value" id="chart-month-usd">$0.00</span>
              </div>
              <div class="chart-item">
                <span class="chart-label">CUP</span>
                <span class="chart-value" id="chart-month-cup">0 CUP</span>
              </div>
            </div>
          </div>
        </div>

        <!-- EstadÃ­sticas -->
        <div class="stats-container">
          <div class="stat-card">
            <span class="stat-label">Promedio piario</span>
            <span class="stat-value" id="chart-avg-day">0 tx/dÃ­a</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">ProyecciÃ³n mensual</span>
            <span class="stat-value" id="chart-projection">$0.00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Detalles TransacciÃ³n (DirecciÃ³n + Mapa + PDF) -->
    <div id="modal-details" class="modal">
      <div class="modal-content" style="max-width: 900px">
        <span class="close" onclick="cerrarModal('modal-details')"
          >&times;</span
        >
        <h2>Detalles de la transferencia</h2>
        <div
          style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
          "
        >
          <div>
            <h4>InformaciÃ³n del remitente</h4>
            <p><strong>Nombre:</strong> <span id="det-sender"></span></p>
            <p><strong>WhatsApp:</strong> <span id="det-sender-wa"></span></p>
          </div>
          <div>
            <h4>InformaciÃ³n del destinatario</h4>
            <p><strong>Nombre:</strong> <span id="det-recipient"></span></p>
            <p>
              <strong>WhatsApp:</strong> <span id="det-recipient-wa"></span>
            </p>
          </div>
        </div>
        <div>
          <h4>DirecciÃ³n completa</h4>
          <div
            id="det-address"
            style="
              background: rgba(255, 255, 255, 0.05);
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 20px;
            "
          ></div>
        </div>
        <div id="det-map-container" style="margin-bottom: 20px">
          <h4>UbicaciÃ³n en el mapa</h4>
          <div
            id="det-map"
            style="height: 300px; width: 100%; border-radius: 8px"
          ></div>
        </div>
        <div style="display: flex; gap: 10px">
          <button class="btn btn-primary" onclick="generarPDF()">
            Generar PDF
          </button>
          <button
            class="btn btn-primary btn-whatsapp"
            onclick="enviarWA_Remitente()"
          >
            Confirmar remitente
          </button>
          <button
            class="btn btn-primary btn-whatsapp"
            onclick="enviarWA_Destinatario()"
          >
            Confirmar destinatario
          </button>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script type="module" src="./js/panelMain.js"></script>
  </body>
</html>
